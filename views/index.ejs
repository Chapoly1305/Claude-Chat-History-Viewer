<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Chat History</title>
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
    <link rel="stylesheet" href="/css/claude-sidebar.css">
</head>
<body>
    <div class="explorer-layout three-panel">
        <!-- Panel 1: Sidebar (Folders) -->
        <aside class="explorer-sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Explorer</h2>
            </div>
            <div class="folder-tree" id="folder-tree">
                <div class="folder-item active expanded" data-path="">
                    <div class="folder-header" onclick="selectFolder('')">
                        <span class="folder-toggle expanded">‚ñ∂</span>
                        <span class="folder-icon">üìÅ</span>
                        <span class="folder-name"><%= folderTree.name %></span>
                        <span class="folder-count"><%= folderTree.count %></span>
                    </div>
                    <div class="folder-children">
                        <% folderTree.children.forEach(project => { %>
                            <div class="folder-item" data-path="<%= project.path %>">
                                <div class="folder-header" onclick="selectFolder('<%= project.path %>')">
                                    <span class="folder-toggle no-children">‚ñ∂</span>
                                    <span class="folder-icon">üìÇ</span>
                                    <span class="folder-name"><%= project.name %></span>
                                    <span class="folder-count"><%= project.count %></span>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                </div>
            </div>

            <div class="theme-toggle">
                <span class="theme-icon" id="dark-icon">üåô</span>
                <label class="theme-switch">
                    <input type="checkbox" id="theme-toggle-input" onchange="toggleTheme()">
                    <span class="theme-slider"></span>
                </label>
                <span class="theme-icon" id="light-icon">‚òÄÔ∏è</span>
            </div>
        </aside>

        <!-- Mobile sidebar overlay -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- Panel 2: Chat List -->
        <section class="chat-list-panel" id="chat-list-panel">
            <header class="list-header">
                <div class="list-title">
                    <span id="visible-count"><%= stats.totalConversations %></span> conversations
                </div>
                <div class="search-wrapper">
                    <input type="text" class="search-input" id="search-input" placeholder="Search..." />
                </div>
            </header>

            <!-- Time Slider Histogram -->
            <div class="time-slider-container" id="time-slider">
                <div class="time-slider-header">
                    <span class="time-slider-title">Timeline</span>
                    <div class="time-slider-controls">
                        <button class="metric-toggle" id="metric-toggle" title="Toggle metric">
                            <span class="metric-label" id="metric-label">Chats</span>
                        </button>
                        <button class="clear-range-btn" id="clear-range" title="Clear selection" style="display: none;">‚úï</button>
                    </div>
                </div>
                <div class="histogram-container">
                    <div class="histogram-bars" id="histogram-bars"></div>
                    <div class="histogram-selection" id="histogram-selection"></div>
                </div>
                <div class="time-slider-labels" id="time-labels"></div>
                <div class="time-slider-range" id="range-display" style="display: none;"></div>
            </div>

            <div class="chat-list" id="chat-list">
                <% monthGroups.forEach(group => { %>
                    <div class="month-group" data-month="<%= group.key %>">
                        <div class="month-header" onclick="toggleMonth('<%= group.key %>')">
                            <span class="month-toggle">‚ñº</span>
                            <span class="month-label"><%= group.label %></span>
                            <span class="month-count">(<%= group.chats.length %>)</span>
                        </div>
                        <div class="month-chats">
                            <% group.chats.forEach(chat => { %>
                                <div class="chat-card"
                                     data-project="<%= chat.projectName %>"
                                     data-project-dir="<%= chat.projectDir %>"
                                     data-chat-id="<%= chat.id %>"
                                     data-title="<%= typeof chat.firstMessage === 'string' ? chat.firstMessage : '' %>"
                                     data-searchable="<%= typeof chat.searchableText === 'string' ? chat.searchableText.substring(0, 1000) : '' %>"
                                     data-date="<%= chat.modifiedTime %>"
                                     onclick="selectChat('<%= chat.projectDir %>', '<%= chat.id %>')">
                                    <div class="chat-meta">
                                        <span class="chat-date"><%= moment(chat.modifiedTime).format('MMM D, h:mm A') %></span>
                                        <span class="chat-project"><%= chat.projectName %></span>
                                    </div>
                                    <div class="chat-title">
                                        <% if (chat.enhancedSummary && chat.enhancedSummary.oneLine) { %>
                                            <%= chat.enhancedSummary.oneLine %>
                                        <% } else { %>
                                            <% const title = typeof chat.firstMessage === 'string' ? chat.firstMessage : 'Untitled Chat'; %>
                                            <%= title.substring(0, 80) %><%= title.length > 80 ? '...' : '' %>
                                        <% } %>
                                    </div>
                                    <div class="chat-info">
                                        <span class="message-count"><%= chat.messageCount %> msgs</span>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    </div>
                <% }) %>

                <div class="empty-state" id="empty-state" style="display: none;">
                    <div class="empty-state-icon">üîç</div>
                    <div class="empty-state-text">No conversations found</div>
                </div>
            </div>
        </section>

        <!-- Panel 3: Chat Detail -->
        <main class="chat-detail-panel" id="chat-detail-panel">
            <div class="detail-empty" id="detail-empty">
                <div class="detail-empty-icon">üí¨</div>
                <div class="detail-empty-text">Select a conversation</div>
                <div class="detail-empty-hint">Click on a chat from the list to view it here</div>
            </div>

            <div class="detail-content" id="detail-content" style="display: none;">
                <header class="detail-header">
                    <div class="detail-title" id="detail-title"></div>
                    <div class="detail-meta">
                        <span class="detail-project" id="detail-project"></span>
                        <span class="detail-count" id="detail-count"></span>
                        <a href="#" class="detail-link" id="detail-link" target="_blank" title="Open in new tab">‚Üó</a>
                        <a href="#" class="detail-download" id="detail-download" title="Download">üì•</a>
                    </div>
                </header>
                <div class="detail-messages" id="detail-messages"></div>
            </div>

            <div class="detail-loading" id="detail-loading" style="display: none;">
                <div class="loading-spinner"></div>
                <div>Loading...</div>
            </div>
        </main>

        <!-- Mobile toggle -->
        <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()">üìÅ</button>
    </div>

    <script>
        window.conversationData = <%- JSON.stringify(allChats.map(c => ({
            date: c.modifiedTime,
            messages: c.messageCount,
            project: c.projectName
        }))) %>;
    </script>
    <script src="/js/time-slider.js"></script>
    <script src="/js/explorer.js"></script>
</body>
</html>
