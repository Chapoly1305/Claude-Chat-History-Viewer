<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Chat History</title>
    <link rel="stylesheet" href="/css/claude-sidebar.css">
</head>
<body>
    <div class="explorer-layout">
        <!-- Sidebar -->
        <aside class="explorer-sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Explorer</h2>
            </div>
            <div class="folder-tree" id="folder-tree">
                <!-- All Conversations (root) -->
                <div class="folder-item active expanded" data-path="">
                    <div class="folder-header" onclick="selectFolder('')">
                        <span class="folder-toggle expanded">‚ñ∂</span>
                        <span class="folder-icon">üìÅ</span>
                        <span class="folder-name"><%= folderTree.name %></span>
                        <span class="folder-count"><%= folderTree.count %></span>
                    </div>
                    <div class="folder-children">
                        <% folderTree.children.forEach(project => { %>
                            <div class="folder-item" data-path="<%= project.path %>">
                                <div class="folder-header" onclick="selectFolder('<%= project.path %>')">
                                    <span class="folder-toggle no-children">‚ñ∂</span>
                                    <span class="folder-icon">üìÇ</span>
                                    <span class="folder-name"><%= project.name %></span>
                                    <span class="folder-count"><%= project.count %></span>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                </div>
            </div>

            <!-- Theme Toggle -->
            <div class="theme-toggle">
                <span class="theme-icon" id="dark-icon">üåô</span>
                <label class="theme-switch">
                    <input type="checkbox" id="theme-toggle-input" onchange="toggleTheme()">
                    <span class="theme-slider"></span>
                </label>
                <span class="theme-icon" id="light-icon">‚òÄÔ∏è</span>
            </div>
        </aside>

        <!-- Mobile sidebar overlay -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- Content Panel -->
        <main class="explorer-content">
            <header class="content-header">
                <h1>Claude Chat History <a href="/history-index.json" class="json-link" title="View history index as JSON">üìä</a></h1>

                <!-- Breadcrumb -->
                <nav class="breadcrumb" id="breadcrumb">
                    <span class="breadcrumb-item active" data-path="">All Conversations</span>
                </nav>

                <!-- Stats -->
                <div class="content-stats">
                    <div class="content-stat">
                        <span class="content-stat-value"><%= stats.totalProjects %></span>
                        <span>projects</span>
                    </div>
                    <div class="content-stat">
                        <span class="content-stat-value" id="visible-count"><%= stats.totalConversations %></span>
                        <span>conversations</span>
                    </div>
                    <div class="content-stat">
                        <span class="content-stat-value"><%= stats.totalMessages %></span>
                        <span>messages</span>
                    </div>
                </div>
            </header>

            <div class="content-body">
                <!-- Search -->
                <div class="content-search">
                    <div class="search-wrapper">
                        <input type="text"
                               class="content-search-input"
                               id="search-input"
                               placeholder="Search conversations..." />
                    </div>
                </div>

                <!-- Time Slider Histogram -->
                <div class="time-slider-container" id="time-slider">
                    <div class="time-slider-header">
                        <span class="time-slider-title">Activity Timeline</span>
                        <div class="time-slider-controls">
                            <button class="metric-toggle" id="metric-toggle" title="Toggle metric">
                                <span class="metric-label" id="metric-label">Conversations</span>
                            </button>
                            <button class="clear-range-btn" id="clear-range" title="Clear date selection" style="display: none;">‚úï</button>
                        </div>
                    </div>
                    <div class="histogram-container">
                        <div class="histogram-bars" id="histogram-bars"></div>
                        <div class="histogram-selection" id="histogram-selection"></div>
                    </div>
                    <div class="time-slider-labels" id="time-labels"></div>
                    <div class="time-slider-range" id="range-display" style="display: none;"></div>
                </div>

                <!-- Chat list grouped by month -->
                <div class="chat-list" id="chat-list">
                    <% monthGroups.forEach(group => { %>
                        <div class="month-group" data-month="<%= group.key %>">
                            <div class="month-header" onclick="toggleMonth('<%= group.key %>')">
                                <span class="month-toggle">‚ñº</span>
                                <span class="month-label"><%= group.label %></span>
                                <span class="month-count">(<%= group.chats.length %>)</span>
                            </div>
                            <div class="month-chats">
                                <% group.chats.forEach(chat => { %>
                                    <div class="explorer-chat-card"
                                         data-project="<%= chat.projectName %>"
                                         data-title="<%= typeof chat.firstMessage === 'string' ? chat.firstMessage : '' %>"
                                         data-searchable="<%= typeof chat.searchableText === 'string' ? chat.searchableText.substring(0, 1000) : '' %>"
                                         data-date="<%= chat.modifiedTime %>">
                                        <a href="/chat/<%= chat.projectDir %>/<%= chat.id %>" class="chat-link">
                                            <div class="chat-meta">
                                                <span class="chat-date"><%= moment(chat.modifiedTime).format('MMM D, h:mm A') %></span>
                                                <span class="chat-project"><%= chat.projectName %></span>
                                            </div>
                                            <div class="chat-title">
                                                <% if (chat.enhancedSummary && chat.enhancedSummary.oneLine) { %>
                                                    <%= chat.enhancedSummary.oneLine %>
                                                <% } else { %>
                                                    <% const title = typeof chat.firstMessage === 'string' ? chat.firstMessage : 'Untitled Chat'; %>
                                                    <%= title.substring(0, 100) %><%= title.length > 100 ? '...' : '' %>
                                                <% } %>
                                            </div>
                                            <div class="chat-summary-text">
                                                <% if (chat.enhancedSummary && chat.enhancedSummary.paragraph) { %>
                                                    <%= chat.enhancedSummary.paragraph.substring(0, 150) %><%= chat.enhancedSummary.paragraph.length > 150 ? '...' : '' %>
                                                <% } else if (typeof chat.summary === 'string') { %>
                                                    <%= chat.summary.replace(/<[^>]*>/g, '').substring(0, 150) %>
                                                <% } %>
                                            </div>
                                        </a>
                                        <div class="chat-footer">
                                            <span class="message-count"><%= chat.messageCount %> messages</span>
                                            <a href="/download/<%= chat.projectDir %>/<%= chat.id %>" class="download-link" title="Download as Markdown">üì•</a>
                                        </div>
                                    </div>
                                <% }) %>
                            </div>
                        </div>
                    <% }) %>

                    <!-- Empty state -->
                    <div class="empty-state" id="empty-state" style="display: none;">
                        <div class="empty-state-icon">üîç</div>
                        <div class="empty-state-text">No conversations found</div>
                        <div class="empty-state-hint">Try a different search term or folder</div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Mobile sidebar toggle button -->
        <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()">
            üìÅ
        </button>
    </div>

    <script>
        // Pass conversation data to client for histogram
        window.conversationData = <%- JSON.stringify(allChats.map(c => ({
            date: c.modifiedTime,
            messages: c.messageCount,
            project: c.projectName
        }))) %>;
    </script>
    <script src="/js/time-slider.js"></script>
    <script src="/js/explorer.js"></script>
</body>
</html>
